/*
 * motor_encoder.c
 *
 *  Created on: Dec 14, 2023
 *      Author: miqix
 */
#include "Motors/motor_encoder.h"


void MotorEnc_Init(MotorEncoder_t *encoder, TIM_HandleTypeDef *htim)
{
	encoder->htimEnc = htim;
}

void MotorEnc_Uptade(MotorEncoder_t *encoder)
{
	uint32_t NewCounter = encoder->htimEnc->Instance->CNT;

	if(NewCounter == encoder->LastCounter)
	{
		encoder->Velocity = 0;
	}
	else if(NewCounter > encoder->LastCounter)
	{
		if(__HAL_TIM_IS_TIM_COUNTING_DOWN(encoder->htimEnc))
		{
			encoder->Velocity = - ( encoder->LastCounter + (encoder->htimEnc->Instance->ARR - NewCounter) );
		}
		else
		{
			encoder->Velocity = NewCounter - encoder->LastCounter;
		}
	}
	else if(NewCounter < encoder->LastCounter)
	{
		if(__HAL_TIM_IS_TIM_COUNTING_DOWN(encoder->htimEnc))
		{
			encoder->Velocity = NewCounter - encoder->LastCounter;
		}
		else
		{
			encoder->Velocity = NewCounter + (encoder->htimEnc->Instance->ARR + encoder->LastCounter);
		}
	}
}
